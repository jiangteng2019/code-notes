## tomcat多线程与servlet调用

### 当一个HTTP请求到达Tomcat服务器时，Tomcat会按照以下步骤处理该请求：

1. 接收请求:
   Tomcat的连接器（Connector）组件负责监听指定的端口（通常是8080），一旦有HTTP请求到来，它将接收该请求。连接器使用底层的网络通信（例如Java的Socket）来实现。

1. 创建请求和响应对象:
   对于每个接收到的请求，Tomcat会创建对应的HttpServletRequest和HttpServletResponse对象。这些对象封装了请求信息和响应信息，可以被开发者在Servlet中使用。

1. 分配线程:
   Tomcat拥有一个线程池，用于处理请求。当一个请求到来时，Tomcat会从线程池中分配一个线程来处理这个请求。这样做的目的是为了提高服务器处理请求的效率，因为创建和销毁线程是一个昂贵的操作。

1. 请求分派:
   Tomcat根据web.xml中定义的URL模式将请求分派给相应的Servlet。如果请求匹配某个Servlet的URL模式，则由该Servlet处理；如果没有匹配的Servlet，Tomcat可能会返回404错误。

1. Servlet处理:
   一旦确定了处理请求的Servlet，Tomcat线程会调用该Servlet的service方法。service方法会进一步根据HTTP请求的类型（GET、POST、PUT、DELETE等）调用doGet、doPost、doPut、doDelete等相应的方法。开发者在这些方法中实现业务逻辑。

1. 生成响应:
   在Servlet的处理方法中，开发者可以通过HttpServletResponse对象设置响应状态码、响应头、响应体等。处理完成后，Tomcat会将这些响应信息发送回客户端。

1. 线程回收:
   一旦响应被发送，处理该请求的线程会完成工作，并被回收到线程池中，等待处理下一个请求。

在整个过程中，多线程的使用使得Tomcat能够同时处理多个请求，提高了并发处理能力。每个请求都在自己的线程中独立处理，互不干扰。Servlet是无状态的，意味着Servlet不会保存任何与特定请求相关的状态信息。这样，同一个Servlet实例可以被多个线程（即处理多个请求）同时调用，因此在Servlet中处理共享资源时需要注意线程安全问题。

当HTTP请求使用了Keep-Alive字段，这意味着客户端希望保持TCP连接打开，以便发送后续的请求，而无需每次请求都重新建立连接。这种机制可以减少建立和关闭连接的开销，提高效率。

### 在Tomcat等Web服务器中，使用Keep-Alive时的处理如下：

1. 请求处理结束:
   当一个请求被处理完毕，响应发送给客户端后，如果该请求使用了Keep-Alive，那么Tomcat并不会立即关闭TCP连接。相反，它会保持该连接打开一段预定义的时间（Keep-Alive超时时间），等待可能的后续请求。

1. 线程释放:
   尽管TCP连接保持打开状态，但是处理完当前请求的线程不会一直挂起等待新的请求。相反，该线程会被释放回线程池，以供其他新到来的请求使用。

1. 新请求的处理:
   如果在Keep-Alive超时时间内，同一个TCP连接上有新的请求到来，Tomcat会从线程池中取出一个新的线程来处理这个请求。这个新线程可能是原来的线程，也可能是线程池中的另一个线程。因为线程是从线程池中动态分配的，所以没有固定的线程与特定的TCP连接绑定。

1. 连接超时:
   如果在Keep-Alive超时时间内没有新的请求，那么Tomcat最终会关闭该TCP连接。如果客户端在连接关闭后发送请求，那么必须重新建立新的TCP连接。

总的来说，即使是在使用Keep-Alive的情况下，处理请求的线程在完成任务后也会被释放，以便服务其他请求。TCP连接保持打开状态，但不会持续占用线程资源。这样做既保持了连接复用的效率，又保证了线程资源的有效利用。方法的执行在线程中是私有的，每个线程执行某个方法不影响。
